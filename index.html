<h1 id="ruby-cute">Ruby-Cute</h1>
<p>Ruby-Cute is a set of <em>Commonly Used Tools for Experiments</em>, or <em>Critically Useful Tools for Experiments</em>, depending on who you ask. It is a library aggregating various Ruby snippets useful in the context of (but not limited to) development of experiment software on distributed systems testbeds such as Grid'5000.</p>
<h2 id="installation">Installation</h2>
<p>From sources:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">git</span> clone https://github.com/ruby-cute/ruby-cute
$ <span class="kw">cd</span> ruby-cute
$ <span class="kw">gem</span> build ruby-cute.gemspec
$ <span class="kw">gem</span> install ruby-cute-*.gem</code></pre>
<p>In Grid'5000 the installation procedure goes as follows:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">gem</span> install --user-install ruby-cute-*.gem</code></pre>
<p>Then, type the following for having ruby cute in your path (this is only necessary if you want to use interactive mode).</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">export</span> <span class="ot">PATH=$PATH</span>:<span class="ot">$(</span><span class="kw">ruby</span> -e <span class="st">&#39;puts &quot;#{Gem.user_dir}/bin&quot;&#39;</span><span class="ot">)</span></code></pre>
<h2 id="overview">Overview</h2>
<p>Ruby-Cute is structured in different modules that allows you to:</p>
<ul>
<li><p>communicate with Grid'5000 through the G5K Module. For more details please refer to <a href="http://www.rubydoc.info/github/ruby-cute/ruby-cute/master/Cute/G5K/API">G5K Module</a>.</p></li>
<li><p>execute commands in several remote machines in parallel. Two modules are available for that:</p>
<ul>
<li><a href="http://www.rubydoc.info/github/ruby-cute/ruby-cute/master/Net/SSH/Multi">Net::SSH::Multi</a> that uses the SSH protocol.</li>
<li><a href="http://www.rubydoc.info/github/ruby-cute/ruby-cute/master/Cute/TakTuk">Taktuk</a> which is a wrapper of <a href="http://taktuk.gforge.inria.fr">taktuk</a> parallel command executor.</li>
</ul></li>
</ul>
<p>An example of use of Ruby-Cute in a real use case is available in <a href="http://www.rubydoc.info/github/ruby-cute/ruby-cute/master/file/examples/g5k_exp_virt.rb">Virtualization on Grid'5000</a></p>
<h2 id="using-pry----an-interactive-ruby-shell">Using pry -- an interactive ruby shell</h2>
<p>Sometimes it may be useful to work in interactive mode. For this we can use an interactive ruby shell such as irb that is shipped by default with Ruby, however, we highly recommend to use <a href="http://pryrepl.org/">pry</a>, it features syntax highlighting, method auto completion and command shell integration. For installing pry type the following:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">gem</span> install pry</code></pre>
<p>or, for installing in the user home directory:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">gem</span> install --user-install pry</code></pre>
<p>When Ruby-Cute is installed, it provides a wrapper for an interactive shell that will automatically load the necessary libraries. The following will get a <em>pry</em> prompt (if installed).</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">cute</span>
[<span class="kw">1</span>] pry(main)<span class="kw">&gt;</span></code></pre>
<p>The variable <em>$g5k</em> is available which can be used to access the Grid'5000 API through the <a href="http://www.rubydoc.info/github/ruby-cute/ruby-cute/master/Cute/G5K/API">G5K Module</a>. For example, let's request the name of the sites available in Grid'5000.</p>
<pre class="sourceCode bash"><code class="sourceCode bash">[<span class="kw">2</span>] pry(main)<span class="kw">&gt;</span> <span class="ot">$g5k</span><span class="kw">.site_uids</span>()
 =<span class="kw">&gt;</span> [<span class="st">&quot;grenoble&quot;</span>, <span class="st">&quot;lille&quot;</span>, <span class="st">&quot;luxembourg&quot;</span>, <span class="st">&quot;lyon&quot;</span>, <span class="st">&quot;nancy&quot;</span>, <span class="st">&quot;nantes&quot;</span>, <span class="st">&quot;reims&quot;</span>, <span class="st">&quot;rennes&quot;</span>, <span class="st">&quot;sophia&quot;</span>, <span class="st">&quot;toulouse&quot;</span>]</code></pre>
<p>We can get the status of nodes in a given site by using:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">[<span class="kw">8</span>] pry(main)<span class="kw">&gt;</span> <span class="ot">$g5k</span><span class="kw">.nodes_status</span>(<span class="st">&quot;lyon&quot;</span>)
 =<span class="kw">&gt;</span> {<span class="st">&quot;taurus-2.lyon.grid5000.fr&quot;</span>=<span class="kw">&gt;</span><span class="st">&quot;besteffort&quot;</span>, <span class="st">&quot;taurus-16.lyon.grid5000.fr&quot;</span>=<span class="kw">&gt;</span><span class="st">&quot;besteffort&quot;</span>, <span class="st">&quot;taurus-15.lyon.grid5000.fr&quot;</span>=<span class="kw">&gt;</span><span class="st">&quot;besteffort&quot;</span>, <span class="kw">...</span>}</code></pre>
<p>Within this shell you have preloaded <a href="http://www.rubydoc.info/github/ruby-cute/ruby-cute/master/Cute/G5K/API">G5K Module</a>, <a href="http://www.rubydoc.info/github/ruby-cute/ruby-cute/master/Cute/TakTuk">Taktuk</a> and <a href="http://www.rubydoc.info/github/ruby-cute/ruby-cute/master/Net/SSH/Multi">Net::SSH::Multi</a>, you can go directly to their respective documentation to know how to take advantage of them.</p>
<h3 id="experiment-example">Experiment example</h3>
<p>The following example shows how to use the <a href="http://www.rubydoc.info/github/ruby-cute/ruby-cute/master/Cute/G5K/API">G5K Module</a> in an experiment. This example implements the experiment described in <a href="https://www.grid5000.fr/mediawiki/index.php/Run_MPI_On_Grid%275000#Setting_up_and_starting_Open_MPI_to_use_high_performance_interconnect">MPI on Grid5000</a>.</p>
<pre class="sourceCode ruby"><code class="sourceCode ruby">require <span class="st">&#39;cute&#39;</span>
require <span class="st">&#39;net/scp&#39;</span>

g5k = <span class="dt">Cute</span>::<span class="dt">G5K</span>::<span class="dt">API</span>.new()
<span class="co"># We reuse a job if there is one available.</span>
<span class="dt">G5K_SITE</span> = <span class="st">&quot;nancy&quot;</span> <span class="co"># the chosen site has to have Infiniband 20G (e.g nancy, grenoble)</span>
<span class="kw">if</span> g5k.get_my_jobs(<span class="dt">G5K_SITE</span>).empty?
   job = g5k.reserve(<span class="st">:site</span> =&gt; <span class="dt">G5K_SITE</span>, <span class="st">:resources</span> =&gt; <span class="st">&quot;{ib20g=&#39;YES&#39;}/nodes=2/core=1&quot;</span>,<span class="st">:walltime</span> =&gt; <span class="st">&#39;00:30:00&#39;</span>, <span class="st">:keys</span> =&gt; <span class="st">&quot;~/my_ssh_jobkey&quot;</span> )
<span class="kw">else</span>
   job = g5k.get_my_jobs(<span class="dt">G5K_SITE</span>).first
<span class="kw">end</span>

nodes = job[<span class="st">&quot;assigned_nodes&quot;</span>]

grid5000_opt = {<span class="st">:user</span> =&gt; <span class="st">&quot;oar&quot;</span>, <span class="st">:keys</span> =&gt; [<span class="st">&quot;~/my_ssh_jobkey&quot;</span>], <span class="st">:port</span> =&gt; <span class="dv">6667</span> }

machine_file = <span class="dt">Tempfile</span>.open(<span class="st">&#39;machine_file&#39;</span>)

nodes.each{ |node| machine_file.puts node }

machine_file.close

netpipe =<span class="st">&quot;http://pkgs.fedoraproject.org/repo/pkgs/NetPIPE/NetPIPE-3.7.1.tar.gz/5f720541387be065afdefc81d438b712/NetPIPE-3.7.1.tar.gz&quot;</span>

<span class="co"># We use the first node reserved.</span>
<span class="dt">Net</span>::<span class="dt">SCP</span>.start(nodes.first, <span class="st">&quot;oar&quot;</span>, grid5000_opt) <span class="kw">do</span> |scp|
   scp.upload! machine_file.path, <span class="st">&quot;/tmp/machine_file&quot;</span>
<span class="kw">end</span>

<span class="dt">Net</span>::<span class="dt">SSH</span>.start(nodes.first, <span class="st">&quot;oar&quot;</span>, grid5000_opt) <span class="kw">do</span> |ssh|
   ssh.exec!(<span class="st">&quot;mkdir -p netpipe_exp&quot;</span>)
   ssh.exec!(<span class="st">&quot;export http_proxy=\&quot;http://proxy:3128\&quot;; wget -O ~/netpipe_exp/NetPIPE.tar.gz </span><span class="ot">#{</span>netpipe<span class="ot">}</span><span class="st">&quot;</span>)
   ssh.exec!(<span class="st">&quot;cd netpipe_exp &amp;&amp; tar -zvxf NetPIPE.tar.gz&quot;</span>)
   ssh.exec!(<span class="st">&quot;cd netpipe_exp/NetPIPE-3.7.1 &amp;&amp; make mpi&quot;</span>)
   ssh.exec(<span class="st">&quot;mpirun --mca plm_rsh_agent \&quot;oarsh\&quot; -machinefile /tmp/machine_file ~/netpipe_exp/NetPIPE-3.7.1/NPmpi&quot;</span>)
<span class="kw">end</span>

g5k.release(job) <span class="co"># Frees resources.</span></code></pre>
<h2 id="contact-information">Contact information</h2>
<p>Ruby-Cute is maintained by the Algorille team at LORIA/Inria Nancy - Grand Est, and specifically by:</p>
<ul>
<li>SÃ©bastien Badia <script type="text/javascript">
<!--
h='&#x69;&#110;&#114;&#x69;&#x61;&#46;&#102;&#114;';a='&#64;';n='&#x73;&#x65;&#98;&#x61;&#x73;&#116;&#x69;&#x65;&#110;&#46;&#98;&#x61;&#100;&#x69;&#x61;';e=n+a+h;
document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'">'+e+'<\/'+'a'+'>');
// -->
</script><noscript>&#x73;&#x65;&#98;&#x61;&#x73;&#116;&#x69;&#x65;&#110;&#46;&#98;&#x61;&#100;&#x69;&#x61;&#32;&#x61;&#116;&#32;&#x69;&#110;&#114;&#x69;&#x61;&#32;&#100;&#x6f;&#116;&#32;&#102;&#114;</noscript></li>
<li>Tomasz Buchert <script type="text/javascript">
<!--
h='&#x69;&#110;&#114;&#x69;&#x61;&#46;&#102;&#114;';a='&#64;';n='&#116;&#x6f;&#x6d;&#x61;&#x73;&#122;&#46;&#98;&#x75;&#x63;&#104;&#x65;&#114;&#116;';e=n+a+h;
document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'">'+e+'<\/'+'a'+'>');
// -->
</script><noscript>&#116;&#x6f;&#x6d;&#x61;&#x73;&#122;&#46;&#98;&#x75;&#x63;&#104;&#x65;&#114;&#116;&#32;&#x61;&#116;&#32;&#x69;&#110;&#114;&#x69;&#x61;&#32;&#100;&#x6f;&#116;&#32;&#102;&#114;</noscript></li>
<li>Emmanuel Jeanvoine <script type="text/javascript">
<!--
h='&#x69;&#110;&#114;&#x69;&#x61;&#46;&#102;&#114;';a='&#64;';n='&#x65;&#x6d;&#x6d;&#x61;&#110;&#x75;&#x65;&#108;&#46;&#106;&#x65;&#x61;&#110;&#118;&#x6f;&#x69;&#110;&#x65;';e=n+a+h;
document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'">'+e+'<\/'+'a'+'>');
// -->
</script><noscript>&#x65;&#x6d;&#x6d;&#x61;&#110;&#x75;&#x65;&#108;&#46;&#106;&#x65;&#x61;&#110;&#118;&#x6f;&#x69;&#110;&#x65;&#32;&#x61;&#116;&#32;&#x69;&#110;&#114;&#x69;&#x61;&#32;&#100;&#x6f;&#116;&#32;&#102;&#114;</noscript></li>
<li>Lucas Nussbaum <script type="text/javascript">
<!--
h='&#108;&#x6f;&#114;&#x69;&#x61;&#46;&#102;&#114;';a='&#64;';n='&#108;&#x75;&#x63;&#x61;&#x73;&#46;&#110;&#x75;&#x73;&#x73;&#98;&#x61;&#x75;&#x6d;';e=n+a+h;
document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'">'+e+'<\/'+'a'+'>');
// -->
</script><noscript>&#108;&#x75;&#x63;&#x61;&#x73;&#46;&#110;&#x75;&#x73;&#x73;&#98;&#x61;&#x75;&#x6d;&#32;&#x61;&#116;&#32;&#108;&#x6f;&#114;&#x69;&#x61;&#32;&#100;&#x6f;&#116;&#32;&#102;&#114;</noscript></li>
<li>Luc Sarzyniec <script type="text/javascript">
<!--
h='&#x69;&#110;&#114;&#x69;&#x61;&#46;&#102;&#114;';a='&#64;';n='&#108;&#x75;&#x63;&#46;&#x73;&#x61;&#114;&#122;&#x79;&#110;&#x69;&#x65;&#x63;';e=n+a+h;
document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'">'+e+'<\/'+'a'+'>');
// -->
</script><noscript>&#108;&#x75;&#x63;&#46;&#x73;&#x61;&#114;&#122;&#x79;&#110;&#x69;&#x65;&#x63;&#32;&#x61;&#116;&#32;&#x69;&#110;&#114;&#x69;&#x61;&#32;&#100;&#x6f;&#116;&#32;&#102;&#114;</noscript></li>
<li>Cristian Ruiz <script type="text/javascript">
<!--
h='&#x69;&#110;&#114;&#x69;&#x61;&#46;&#102;&#114;';a='&#64;';n='&#x63;&#114;&#x69;&#x73;&#116;&#x69;&#x61;&#110;&#46;&#114;&#x75;&#x69;&#122;';e=n+a+h;
document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'">'+e+'<\/'+'a'+'>');
// -->
</script><noscript>&#x63;&#114;&#x69;&#x73;&#116;&#x69;&#x61;&#110;&#46;&#114;&#x75;&#x69;&#122;&#32;&#x61;&#116;&#32;&#x69;&#110;&#114;&#x69;&#x61;&#32;&#100;&#x6f;&#116;&#32;&#102;&#114;</noscript></li>
</ul>
<p>Questions/comments should be directed to Lucas Nussbaum and Emmanuel Jeanvoine.</p>
